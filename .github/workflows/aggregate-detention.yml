name: Aggregate Detention Data

on:
  schedule:
    # Run at 5 AM UTC every Sunday (1 hour before Vercel cron at 6 AM)
    - cron: '0 5 * * 0'
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  aggregate:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for auto-commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for aggregation
        run: npm install xlsx unzip-stream sax

      - name: Run aggregation script
        run: node scripts/aggregate-detention.js
        timeout-minutes: 30 # Large file may take time to download and process

      - name: Commit updated aggregates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore: update detention aggregates [automated]'
          file_pattern: 'src/data/detention-aggregates.json'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
